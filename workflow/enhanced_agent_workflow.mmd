flowchart TD
    A[User Input] --> B{Input Type?}
    
    B -->|Incident Description| C{Is valid incident?}
    B -->|Search Query| D[search_incident]
    B -->|Analysis Request| E[analyze_incident]
    
    C -->|No| F[Return help message]
    C -->|Yes| G[Preprocess incident text]
    
    G --> H[Clean whitespace, add time context, add date reference]
    H --> I[Call LLM with preprocessed text]
    
    I --> J{LLM available and returns valid JSON?}
    
    J -->|Yes| K[Structured incident data from LLM]
    J -->|No| L[Use fallback regex tools]
    
    L --> M[Extract date, location, type, impact]
    M --> N[Structured incident data from regex]
    
    K --> O[save_incident to database]
    N --> O
    
    O --> P[process_incident_embeddings]
    P --> Q[Generate vector embeddings for similarity search]
    Q --> R[Store embeddings in vector database]
    
    R --> S[Return success with incident ID]
    
    D --> T[Query vector database with embeddings]
    T --> U[Find similar incidents using cosine similarity]
    U --> V[Return ranked incident matches]
    
    E --> W[Retrieve related incidents from database]
    W --> X[Analyze patterns, trends, root causes]
    X --> Y[Generate insights and recommendations]
    Y --> Z[Return analysis report]
    
    S --> AA[Final Output: Save Confirmation]
    V --> BB[Final Output: Search Results]
    Z --> CC[Final Output: Analysis Report]
    F --> DD[Help/Error Response]
    
    style A fill:#1976d2,color:#ffffff
    style G fill:#7b1fa2,color:#ffffff
    style H fill:#7b1fa2,color:#ffffff
    style I fill:#f57c00,color:#ffffff
    style O fill:#ff8f00,color:#ffffff
    style P fill:#ff8f00,color:#ffffff
    style Q fill:#ff8f00,color:#ffffff
    style R fill:#ff8f00,color:#ffffff
    style D fill:#388e3c,color:#ffffff
    style T fill:#388e3c,color:#ffffff
    style U fill:#388e3c,color:#ffffff
    style E fill:#689f38,color:#ffffff
    style W fill:#689f38,color:#ffffff
    style X fill:#689f38,color:#ffffff
    style Y fill:#689f38,color:#ffffff
    style AA fill:#00796b,color:#ffffff
    style BB fill:#00796b,color:#ffffff
    style CC fill:#00796b,color:#ffffff
    style DD fill:#d32f2f,color:#ffffff